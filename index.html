<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <title>Finance Tracker</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRmluYW5jZSBUcmFja2VyIiwic2hvcnRfbmFtZSI6IkZpbmFuY2UiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMWExYTJlIiwidGhlbWVfY29sb3IiOiIjMWExYTJlIiwic3RhcnRfdXJsIjoiLyJ9">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --accent: #e94560;
            --accent-hover: #d63651;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --text-primary: #eaeaea;
            --text-secondary: #a0a0a0;
            --border: #2d2d4a;
            --input-bg: #252547;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }

        .app {
            max-width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--bg-secondary);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .header h1 {
            font-size: 1.3rem;
        }

        .total-balance {
            text-align: right;
        }

        .total-balance-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .total-balance-amount {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--success);
        }

        .tabs {
            display: flex;
            overflow-x: auto;
            background: var(--bg-tertiary);
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:active {
            background: var(--accent-hover);
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            width: 100%;
            max-width: 500px;
            margin: 2rem auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.3rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--input-bg);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .account-name {
            font-weight: 500;
        }

        .account-balance {
            font-size: 1.1rem;
            color: var(--success);
        }

        .account-type {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .transaction-item {
            padding: 1rem;
            background: var(--input-bg);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .transaction-item:active {
            transform: scale(0.98);
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .transaction-amount {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .transaction-amount.income {
            color: var(--success);
        }

        .transaction-amount.expense {
            color: var(--danger);
        }

        .transaction-amount.transfer {
            color: var(--warning);
        }

        .transaction-details {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .transaction-category {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .filter-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .filter-bar::-webkit-scrollbar {
            display: none;
        }

        .filter-chip {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            white-space: nowrap;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .filter-chip.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: var(--input-bg);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .fab {
            position: fixed;
            bottom: 2rem;
            right: 1.5rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(233, 69, 96, 0.4);
            z-index: 90;
            transition: transform 0.3s;
        }

        .fab:active {
            transform: scale(0.95);
        }

        .row {
            display: flex;
            gap: 1rem;
        }

        .col-2 {
            flex: 1;
        }

        .calculator {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .calc-btn {
            padding: 1rem;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .calc-btn:active {
            background: var(--accent);
        }

        .debt-item {
            padding: 1rem;
            background: var(--input-bg);
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .debt-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .debt-name {
            font-weight: 600;
        }

        .debt-amount {
            font-size: 1.2rem;
            color: var(--warning);
        }

        .debt-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .payment-history {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .payment-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.85rem;
        }

        .linked-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--warning);
            margin-left: 0.5rem;
        }

        .installment-progress {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .search-bar {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .search-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .quick-action-btn {
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-action-btn:active {
            transform: scale(0.98);
            background: var(--bg-tertiary);
        }

        .quick-action-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .quick-action-label {
            font-size: 0.9rem;
        }

        .budget-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .budget-progress {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
        }

        .budget-progress.warning {
            background: var(--warning);
        }

        .budget-progress.danger {
            background: var(--danger);
        }

        .split-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .tag-input {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            min-height: 45px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 16px;
            font-size: 0.9rem;
        }

        .tag-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            font-size: 1rem;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 380px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div class="header-top">
                <h1>Finance Tracker</h1>
                <div class="total-balance">
                    <div class="total-balance-label">Total Balance</div>
                    <div class="total-balance-amount" id="totalBalance">‚Ç±0.00</div>
                </div>
            </div>
            <div class="tabs">
                <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
                <button class="tab-btn" data-tab="transactions">Transactions</button>
                <button class="tab-btn" data-tab="accounts">Accounts</button>
                <button class="tab-btn" data-tab="debt">Debt & Lending</button>
                <button class="tab-btn" data-tab="budgets">Budgets</button>
                <button class="tab-btn" data-tab="reports">Reports</button>
                <button class="tab-btn" data-tab="settings">Settings</button>
            </div>
        </div>

        <div class="content">
            <!-- Dashboard Tab -->
            <div class="tab-content active" id="dashboard">
                <div class="quick-actions">
                    <div class="quick-action-btn" onclick="openAddTransaction('expense')">
                        <div class="quick-action-icon">üí∏</div>
                        <div class="quick-action-label">Add Expense</div>
                    </div>
                    <div class="quick-action-btn" onclick="openAddTransaction('income')">
                        <div class="quick-action-icon">üí∞</div>
                        <div class="quick-action-label">Add Income</div>
                    </div>
                    <div class="quick-action-btn" onclick="openTransferModal()">
                        <div class="quick-action-icon">üîÑ</div>
                        <div class="quick-action-label">Transfer</div>
                    </div>
                    <div class="quick-action-btn" onclick="openDebtModal()">
                        <div class="quick-action-icon">ü§ù</div>
                        <div class="quick-action-label">Lend Money</div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--success)" id="monthIncome">‚Ç±0</div>
                        <div class="stat-label">This Month Income</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--danger)" id="monthExpense">‚Ç±0</div>
                        <div class="stat-label">This Month Expenses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--warning)" id="totalDebt">‚Ç±0</div>
                        <div class="stat-label">Money Lent Out</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--text-primary)" id="transactionCount">0</div>
                        <div class="stat-label">Transactions</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Recent Transactions</h3>
                    </div>
                    <div id="recentTransactions"></div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div class="tab-content" id="transactions">
                <div class="search-bar">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search transactions...">
                    <span class="search-icon">üîç</span>
                </div>

                <div class="filter-bar" id="filterBar">
                    <div class="filter-chip active" data-filter="all">All</div>
                    <div class="filter-chip" data-filter="expense">Expenses</div>
                    <div class="filter-chip" data-filter="income">Income</div>
                    <div class="filter-chip" data-filter="transfer">Transfers</div>
                </div>

                <div id="transactionsList"></div>
            </div>

            <!-- Accounts Tab -->
            <div class="tab-content" id="accounts">
                <button class="btn btn-primary" onclick="openAccountModal()">+ Add Account</button>
                <div id="accountsList"></div>
            </div>

            <!-- Debt & Lending Tab -->
            <div class="tab-content" id="debt">
                <button class="btn btn-primary" onclick="openDebtModal()">+ New Loan</button>
                
                <div class="card">
                    <div class="card-header">
                        <h3>Outstanding Loans</h3>
                    </div>
                    <div id="debtList"></div>
                </div>
            </div>

            <!-- Budgets Tab -->
            <div class="tab-content" id="budgets">
                <button class="btn btn-primary" onclick="openBudgetModal()">+ Set Budget</button>
                <div id="budgetsList"></div>
            </div>

            <!-- Reports Tab -->
            <div class="tab-content" id="reports">
                <div class="card">
                    <h3>Spending by Category</h3>
                    <div id="categoryReport"></div>
                </div>

                <div class="card">
                    <h3>Monthly Comparison</h3>
                    <div id="monthlyComparison"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settings">
                <div class="card">
                    <h3>Categories Management</h3>
                    <button class="btn btn-secondary" onclick="openCategoryModal()">Manage Categories</button>
                </div>

                <div class="card">
                    <h3>Data Management</h3>
                    <button class="btn btn-success" onclick="exportData()">Export Data (CSV)</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import Data</button>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
                    <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                </div>

                <div class="card">
                    <h3>Quick Entry Templates</h3>
                    <button class="btn btn-secondary" onclick="openTemplateModal()">Manage Templates</button>
                </div>
            </div>
        </div>

        <button class="fab" onclick="openAddTransaction()">+</button>
    </div>

    <!-- Add Transaction Modal -->
    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Transaction</h2>
                <button class="close-btn" onclick="closeModal('transactionModal')">√ó</button>
            </div>

            <div class="form-group">
                <label class="form-label">Type</label>
                <select class="form-select" id="txnType" onchange="handleTypeChange()">
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                </select>
            </div>

            <div class="row">
                <div class="col-2">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="txnDate">
                    </div>
                </div>
                <div class="col-2">
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-input" id="txnTime">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Amount (‚Ç±)</label>
                <input type="number" step="0.01" class="form-input" id="txnAmount" placeholder="0.00">
            </div>

            <div class="form-group">
                <label class="form-label">Account</label>
                <select class="form-select" id="txnAccount"></select>
            </div>

            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="txnCategory" onchange="loadSubcategories()"></select>
            </div>

            <div class="form-group" id="subcategoryGroup">
                <label class="form-label">Subcategory</label>
                <select class="form-select" id="txnSubcategory"></select>
            </div>

            <div class="form-group">
                <label class="form-label">Vendor / Location</label>
                <input type="text" class="form-input" id="txnVendor" placeholder="e.g. Jollibee, SM Mall">
            </div>

            <div class="form-group">
                <label class="form-label">Brand (optional)</label>
                <input type="text" class="form-input" id="txnBrand">
            </div>

            <div class="form-group">
                <label class="form-label">Item Details</label>
                <textarea class="form-textarea" id="txnItems" placeholder="What did you buy?"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-textarea" id="txnNotes"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Receipt Link (Google Drive)</label>
                <input type="url" class="form-input" id="txnReceipt" placeholder="https://drive.google.com/...">
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" class="form-checkbox" id="txnTaxDeductible">
                    Tax Deductible
                </label>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" class="form-checkbox" id="txnRecurring">
                    Recurring Transaction
                </label>
            </div>

            <div class="form-group" id="installmentGroup" style="display:none">
                <label class="form-label">Installment Details</label>
                <div class="row">
                    <div class="col-2">
                        <input type="number" class="form-input" id="txnInstallmentCurrent" placeholder="Payment #">
                    </div>
                    <div class="col-2">
                        <input type="number" class="form-input" id="txnInstallmentTotal" placeholder="of Total">
                    </div>
                </div>
                <input type="number" step="0.01" class="form-input" id="txnInstallmentRemaining" placeholder="Remaining Balance" style="margin-top:0.5rem">
            </div>

            <button class="btn btn-primary" onclick="saveTransaction()">Save Transaction</button>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div class="modal" id="transferModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Transfer Money</h2>
                <button class="close-btn" onclick="closeModal('transferModal')">√ó</button>
            </div>

            <div class="row">
                <div class="col-2">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="transferDate">
                    </div>
                </div>
                <div class="col-2">
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-input" id="transferTime">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">From Account</label>
                <select class="form-select" id="transferFrom"></select>
            </div>

            <div class="form-group">
                <label class="form-label">To Account</label>
                <select class="form-select" id="transferTo"></select>
            </div>

            <div class="form-group">
                <label class="form-label">Amount (‚Ç±)</label>
                <input type="number" step="0.01" class="form-input" id="transferAmount">
            </div>

            <div class="form-group">
                <label class="form-label">Transaction Fee (optional)</label>
                <input type="number" step="0.01" class="form-input" id="transferFee" placeholder="0.00">
            </div>

            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-textarea" id="transferNotes"></textarea>
            </div>

            <button class="btn btn-primary" onclick="saveTransfer()">Complete Transfer</button>
        </div>
    </div>

    <!-- Account Modal -->
    <div class="modal" id="accountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Account</h2>
                <button class="close-btn" onclick="closeModal('accountModal')">√ó</button>
            </div>

            <div class="form-group">
                <label class="form-label">Account Name</label>
                <input type="text" class="form-input" id="accountName" placeholder="e.g. BPI Savings">
            </div>

            <div class="form-group">
                <label class="form-label">Account Type</label>
                <select class="form-select" id="accountType">
                    <option value="Savings">Savings</option>
                    <option value="Cash">Cash</option>
                    <option value="Investment">Investment</option>
                    <option value="Digital Wallet">Digital Wallet</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="Debit Card">Debit Card</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Initial Balance (‚Ç±)</label>
                <input type="number" step="0.01" class="form-input" id="accountBalance" value="0">
            </div>

            <button class="btn btn-primary" onclick="saveAccount()">Save Account</button>
        </div>
    </div>

    <!-- Debt/Lending Modal -->
    <div class="modal" id="debtModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Lend Money</h2>
                <button class="close-btn" onclick="closeModal('debtModal')">√ó</button>
            </div>

            <div class="form-group">
                <label class="form-label">Borrower Name</label>
                <input type="text" class="form-input" id="debtName">
            </div>

            <div class="row">
                <div class="col-2">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="debtDate">
                    </div>
                </div>
                <div class="col-2">
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-input" id="debtTime">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Amount Lent (‚Ç±)</label>
                <input type="number" step="0.01" class="form-input" id="debtAmount">
            </div>

            <div class="form-group">
                <label class="form-label">Method of Lending</label>
                <select class="form-select" id="debtMethod"></select>
            </div>

            <div class="form-group">
                <label class="form-label">Purpose / Reason</label>
                <textarea class="form-textarea" id="debtPurpose"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Interest Rate % (optional)</label>
                <input type="number" step="0.01" class="form-input" id="debtInterest" value="0">
            </div>

            <button class="btn btn-primary" onclick="saveDebt()">Record Loan</button>
        </div>
    </div>

    <!-- Repayment Modal -->
    <div class="modal" id="repaymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Record Repayment</h2>
                <button class="close-btn" onclick="closeModal('repaymentModal')">√ó</button>
            </div>

            <input type="hidden" id="repaymentDebtId">

            <div class="row">
                <div class="col-2">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="repaymentDate">
                    </div>
                </div>
                <div class="col-2">
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-input" id="repaymentTime">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Repayment Amount (‚Ç±)</label>
                <input type="number" step="0.01" class="form-input" id="repaymentAmount">
            </div>

            <div class="form-group">
                <label class="form-label">Repayment Method</label>
                <select class="form-select" id="repaymentMethod"></select>
            </div>

            <div class="form-group">
                <label class="form-label">What to do with this cash?</label>
                <select class="form-select" id="cashHandling" onchange="handleCashHandling()">
                    <option value="add_cash">Add to Cash on Hand</option>
                    <option value="deposit">Deposit to Account</option>
                    <option value="partial">Partial Deposit</option>
                </select>
            </div>

            <div class="form-group hidden" id="depositAccountGroup">
                <label class="form-label">Deposit to Account</label>
                <select class="form-select" id="depositAccount"></select>
            </div>

            <div class="form-group hidden" id="partialAmountGroup">
                <label class="form-label">Amount to Deposit (‚Ç±)</label>
                <input type="number" step="0.01" class="form-input" id="partialDepositAmount">
            </div>

            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-textarea" id="repaymentNotes"></textarea>
            </div>

            <button class="btn btn-primary" onclick="saveRepayment()">Record Repayment</button>
        </div>
    </div>

    <!-- Budget Modal -->
    <div class="modal" id="budgetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Set Budget</h2>
                <button class="close-btn" onclick="closeModal('budgetModal')">√ó</button>
            </div>

            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="budgetCategory"></select>
            </div>

            <div class="form-group">
                <label class="form-label">Monthly Budget (‚Ç±)</label>
                <input type="number" step="0.01" class="form-input" id="budgetAmount">
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" class="form-checkbox" id="budgetRollover">
                    Rollover unused budget to next month
                </label>
            </div>

            <button class="btn btn-primary" onclick="saveBudget()">Save Budget</button>
        </div>
    </div>

    <!-- Category Modal -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Manage Categories</h2>
                <button class="close-btn" onclick="closeModal('categoryModal')">√ó</button>
            </div>

            <div class="form-group">
                <label class="form-label">Add New Category</label>
                <input type="text" class="form-input" id="newCategory" placeholder="Category name">
                <select class="form-select" id="newCategoryType" style="margin-top:0.5rem">
                    <option value="expense">Expense Category</option>
                    <option value="income">Income Category</option>
                </select>
                <button class="btn btn-secondary" onclick="addCategory()" style="margin-top:0.5rem">Add Category</button>
            </div>

            <div class="card">
                <h3>Current Categories</h3>
                <div id="categoriesList"></div>
            </div>
        </div>
    </div>

    <script>
        // Data Structure
        let data = {
            accounts: [],
            transactions: [],
            categories: {
                income: ['Salary', 'Freelance', 'Investments', 'Tax Return', 'Gifts', 'Other Income'],
                expense: [
                    'Sustenance & Dining',
                    'Groceries',
                    'Transport',
                    'Shopping',
                    'Bills & Utilities',
                    'Housing',
                    'Health',
                    'Loans & Installments',
                    'Pets',
                    'Entertainment',
                    'Personal Care',
                    'Education',
                    'Travel',
                    'Other'
                ]
            },
            subcategories: {
                'Sustenance & Dining': ['Restaurant', 'Fast Food', 'Caf√©', 'Delivery', 'Takeaway'],
                'Groceries': ['Supermarket', 'Convenience Store', 'Market', 'Online Grocery'],
                'Transport': ['Fuel', 'Public Transport', 'Grab/Taxi', 'Parking', 'Vehicle Registration', 'Insurance'],
                'Shopping': ['Clothing', 'Electronics', 'Home Items', 'Books', 'Gifts'],
                'Bills & Utilities': ['Electricity', 'Gas', 'Water', 'Internet', 'Mobile', 'Streaming'],
                'Housing': ['Rent', 'Mortgage', 'Repairs', 'Furniture', 'Maintenance'],
                'Health': ['Doctor', 'Pharmacy', 'Gym', 'Supplements', 'Insurance'],
                'Loans & Installments': ['Personal Loan', 'Car Loan', 'Credit Card', 'Buy Now Pay Later', 'Appliances'],
                'Pets': ['Pet Food', 'Veterinary', 'Medication', 'Grooming', 'Supplies', 'Insurance', 'Boarding'],
                'Entertainment': ['Movies', 'Games', 'Concerts', 'Sports', 'Hobbies'],
                'Personal Care': ['Haircut', 'Spa', 'Beauty Products', 'Clothing Care'],
                'Education': ['Tuition', 'Books', 'Courses', 'Supplies'],
                'Travel': ['Flights', 'Accommodation', 'Activities', 'Transport'],
                'Other': ['Miscellaneous']
            },
            debts: [],
            budgets: [],
            templates: []
        };

        // Initialize
        function init() {
            loadData();
            setupEventListeners();
            updateAllDisplays();
            setDefaultDateTime();
        }

        function loadData() {
            const saved = localStorage.getItem('financeTrackerData');
            if (saved) {
                data = JSON.parse(saved);
            }
        }

        function saveData() {
            localStorage.setItem('financeTrackerData', JSON.stringify(data));
        }

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    switchTab(tab);
                });
            });

            // Filter chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    filterTransactions(chip.dataset.filter);
                });
            });

            // Search
            document.getElementById('searchInput').addEventListener('input', (e) => {
                searchTransactions(e.target.value);
            });

            // Close modals on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'accounts') displayAccounts();
            if (tabName === 'transactions') displayTransactions();
            if (tabName === 'debt') displayDebts();
            if (tabName === 'budgets') displayBudgets();
            if (tabName === 'reports') displayReports();
            if (tabName === 'dashboard') updateDashboard();
        }

        function setDefaultDateTime() {
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toTimeString().slice(0,5);
            
            const dateInputs = document.querySelectorAll('input[type="date"]');
            const timeInputs = document.querySelectorAll('input[type="time"]');
            
            dateInputs.forEach(input => input.value = date);
            timeInputs.forEach(input => input.value = time);
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            setDefaultDateTime();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            resetForm(modalId);
        }

        function resetForm(modalId) {
            const modal = document.getElementById(modalId);
            modal.querySelectorAll('input, textarea, select').forEach(el => {
                if (el.type === 'checkbox') {
                    el.checked = false;
                } else if (el.type !== 'date' && el.type !== 'time') {
                    el.value = '';
                }
            });
        }

        // Accounts
        function openAccountModal() {
            openModal('accountModal');
        }

        function saveAccount() {
            const name = document.getElementById('accountName').value;
            const type = document.getElementById('accountType').value;
            const balance = parseFloat(document.getElementById('accountBalance').value) || 0;

            if (!name) {
                alert('Please enter account name');
                return;
            }

            data.accounts.push({
                id: Date.now().toString(),
                name,
                type,
                balance,
                createdAt: new Date().toISOString()
            });

            saveData();
            closeModal('accountModal');
            displayAccounts();
            updateAllDisplays();
        }

        function displayAccounts() {
            const container = document.getElementById('accountsList');
            
            if (data.accounts.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí≥</div><p>No accounts yet. Add your first account to start tracking.</p></div>';
                return;
            }

            container.innerHTML = data.accounts.map(account => `
                <div class="account-item">
                    <div>
                        <div class="account-name">${account.name}</div>
                        <div class="account-type">${account.type}</div>
                    </div>
                    <div class="account-balance">‚Ç±${formatNumber(account.balance)}</div>
                </div>
            `).join('');
        }

        function populateAccountDropdowns() {
            const dropdowns = ['txnAccount', 'transferFrom', 'transferTo', 'debtMethod', 'repaymentMethod', 'depositAccount'];
            
            dropdowns.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">Select Account</option>' + 
                        data.accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('');
                }
            });
        }

        // Transactions
        function openAddTransaction(type = 'expense') {
            populateAccountDropdowns();
            loadCategoryOptions();
            openModal('transactionModal');
            document.getElementById('txnType').value = type;
            handleTypeChange();
        }

        function handleTypeChange() {
            const type = document.getElementById('txnType').value;
            loadCategoryOptions();
        }

        function loadCategoryOptions() {
            const type = document.getElementById('txnType').value;
            const categorySelect = document.getElementById('txnCategory');
            const categories = data.categories[type] || [];
            
            categorySelect.innerHTML = '<option value="">Select Category</option>' + 
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            document.getElementById('subcategoryGroup').style.display = 'none';
            
            // Show installment group for Loans & Installments category
            categorySelect.addEventListener('change', () => {
                const selected = categorySelect.value;
                document.getElementById('installmentGroup').style.display = 
                    selected === 'Loans & Installments' ? 'block' : 'none';
            });
        }

        function loadSubcategories() {
            const category = document.getElementById('txnCategory').value;
            const subcategorySelect = document.getElementById('txnSubcategory');
            const subcategoryGroup = document.getElementById('subcategoryGroup');
            
            if (data.subcategories[category]) {
                subcategoryGroup.style.display = 'block';
                subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>' + 
                    data.subcategories[category].map(sub => `<option value="${sub}">${sub}</option>`).join('');
            } else {
                subcategoryGroup.style.display = 'none';
            }
        }

        function saveTransaction() {
            const type = document.getElementById('txnType').value;
            const date = document.getElementById('txnDate').value;
            const time = document.getElementById('txnTime').value;
            const amount = parseFloat(document.getElementById('txnAmount').value);
            const accountId = document.getElementById('txnAccount').value;
            const category = document.getElementById('txnCategory').value;
            const subcategory = document.getElementById('txnSubcategory').value;

            if (!date || !amount || !accountId || !category) {
                alert('Please fill in required fields: Date, Amount, Account, and Category');
                return;
            }

            const account = data.accounts.find(a => a.id === accountId);
            if (!account) return;

            const transaction = {
                id: Date.now().toString(),
                type,
                date,
                time,
                amount,
                accountId,
                accountName: account.name,
                category,
                subcategory,
                vendor: document.getElementById('txnVendor').value,
                brand: document.getElementById('txnBrand').value,
                items: document.getElementById('txnItems').value,
                notes: document.getElementById('txnNotes').value,
                receipt: document.getElementById('txnReceipt').value,
                taxDeductible: document.getElementById('txnTaxDeductible').checked,
                recurring: document.getElementById('txnRecurring').checked,
                createdAt: new Date().toISOString()
            };

            // Handle installments
            if (category === 'Loans & Installments') {
                transaction.installment = {
                    current: parseInt(document.getElementById('txnInstallmentCurrent').value) || 0,
                    total: parseInt(document.getElementById('txnInstallmentTotal').value) || 0,
                    remaining: parseFloat(document.getElementById('txnInstallmentRemaining').value) || 0
                };
            }

            // Update account balance
            if (type === 'expense') {
                account.balance -= amount;
            } else {
                account.balance += amount;
            }

            transaction.balanceAfter = account.balance;

            data.transactions.push(transaction);
            saveData();
            closeModal('transactionModal');
            updateAllDisplays();
        }

        function displayTransactions() {
            const container = document.getElementById('transactionsList');
            const sorted = [...data.transactions].sort((a, b) => 
                new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time)
            );

            if (sorted.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>No transactions yet</p></div>';
                return;
            }

            container.innerHTML = sorted.map(txn => {
                const installmentText = txn.installment ? 
                    `<div class="installment-progress">Payment ${txn.installment.current}/${txn.installment.total} ‚Ä¢ Remaining: ‚Ç±${formatNumber(txn.installment.remaining)}</div>` : '';
                
                return `
                    <div class="transaction-item" onclick="viewTransaction('${txn.id}')">
                        <div class="transaction-header">
                            <div>
                                <div class="transaction-amount ${txn.type}">
                                    ${txn.type === 'expense' ? '-' : '+'}‚Ç±${formatNumber(txn.amount)}
                                </div>
                                <div class="transaction-details">${txn.vendor || txn.category}</div>
                                ${installmentText}
                            </div>
                            <div style="text-align: right;">
                                <div>${formatDate(txn.date)}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary)">${txn.time}</div>
                            </div>
                        </div>
                        <div class="transaction-category">${txn.category}${txn.subcategory ? ' ‚Ä¢ ' + txn.subcategory : ''}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            ${txn.accountName} ‚Ä¢ Balance: ‚Ç±${formatNumber(txn.balanceAfter || 0)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterTransactions(filter) {
            const container = document.getElementById('transactionsList');
            let filtered = [...data.transactions];

            if (filter !== 'all') {
                filtered = filtered.filter(txn => txn.type === filter);
            }

            filtered.sort((a, b) => 
                new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time)
            );

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No transactions found</p></div>';
                return;
            }

            container.innerHTML = filtered.map(txn => {
                const installmentText = txn.installment ? 
                    `<div class="installment-progress">Payment ${txn.installment.current}/${txn.installment.total}</div>` : '';
                
                return `
                    <div class="transaction-item">
                        <div class="transaction-header">
                            <div>
                                <div class="transaction-amount ${txn.type}">
                                    ${txn.type === 'expense' ? '-' : '+'}‚Ç±${formatNumber(txn.amount)}
                                </div>
                                <div class="transaction-details">${txn.vendor || txn.category}</div>
                                ${installmentText}
                            </div>
                            <div style="text-align: right;">
                                <div>${formatDate(txn.date)}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary)">${txn.time}</div>
                            </div>
                        </div>
                        <div class="transaction-category">${txn.category}</div>
                    </div>
                `;
            }).join('');
        }

        function searchTransactions(query) {
            if (!query) {
                displayTransactions();
                return;
            }

            const container = document.getElementById('transactionsList');
            const searchLower = query.toLowerCase();
            
            const results = data.transactions.filter(txn => 
                (txn.vendor && txn.vendor.toLowerCase().includes(searchLower)) ||
                (txn.category && txn.category.toLowerCase().includes(searchLower)) ||
                (txn.notes && txn.notes.toLowerCase().includes(searchLower)) ||
                (txn.items && txn.items.toLowerCase().includes(searchLower))
            );

            if (results.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No results found</p></div>';
                return;
            }

            container.innerHTML = results.map(txn => `
                <div class="transaction-item">
                    <div class="transaction-header">
                        <div>
                            <div class="transaction-amount ${txn.type}">
                                ${txn.type === 'expense' ? '-' : '+'}‚Ç±${formatNumber(txn.amount)}
                            </div>
                            <div class="transaction-details">${txn.vendor || txn.category}</div>
                        </div>
                        <div>${formatDate(txn.date)}</div>
                    </div>
                    <div class="transaction-category">${txn.category}</div>
                </div>
            `).join('');
        }

        // Transfers
        function openTransferModal() {
            if (data.accounts.length < 2) {
                alert('You need at least 2 accounts to make a transfer');
                return;
            }
            populateAccountDropdowns();
            openModal('transferModal');
        }

        function saveTransfer() {
            const fromId = document.getElementById('transferFrom').value;
            const toId = document.getElementById('transferTo').value;
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const fee = parseFloat(document.getElementById('transferFee').value) || 0;
            const date = document.getElementById('transferDate').value;
            const time = document.getElementById('transferTime').value;
            const notes = document.getElementById('transferNotes').value;

            if (!fromId || !toId || !amount || !date) {
                alert('Please fill in all required fields');
                return;
            }

            if (fromId === toId) {
                alert('Cannot transfer to the same account');
                return;
            }

            const fromAccount = data.accounts.find(a => a.id === fromId);
            const toAccount = data.accounts.find(a => a.id === toId);

            if (!fromAccount || !toAccount) return;

            // Update balances
            fromAccount.balance -= (amount + fee);
            toAccount.balance += amount;

            // Create transfer transaction
            const transfer = {
                id: Date.now().toString(),
                type: 'transfer',
                date,
                time,
                amount,
                fee,
                fromAccountId: fromId,
                fromAccountName: fromAccount.name,
                toAccountId: toId,
                toAccountName: toAccount.name,
                notes,
                createdAt: new Date().toISOString()
            };

            data.transactions.push(transfer);

            // If there's a fee, create expense transaction
            if (fee > 0) {
                data.transactions.push({
                    id: (Date.now() + 1).toString(),
                    type: 'expense',
                    date,
                    time,
                    amount: fee,
                    accountId: fromId,
                    accountName: fromAccount.name,
                    category: 'Bills & Utilities',
                    subcategory: 'Transfer Fee',
                    vendor: 'Transfer Fee',
                    notes: `Transfer fee: ${fromAccount.name} to ${toAccount.name}`,
                    createdAt: new Date().toISOString()
                });
            }

            saveData();
            closeModal('transferModal');
            updateAllDisplays();
        }

        // Debt & Lending
        function openDebtModal() {
            populateAccountDropdowns();
            openModal('debtModal');
        }

        function saveDebt() {
            const name = document.getElementById('debtName').value;
            const date = document.getElementById('debtDate').value;
            const time = document.getElementById('debtTime').value;
            const amount = parseFloat(document.getElementById('debtAmount').value);
            const methodId = document.getElementById('debtMethod').value;
            const purpose = document.getElementById('debtPurpose').value;
            const interest = parseFloat(document.getElementById('debtInterest').value) || 0;

            if (!name || !date || !amount || !methodId) {
                alert('Please fill in required fields');
                return;
            }

            const account = data.accounts.find(a => a.id === methodId);
            if (!account) return;

            // Deduct from account
            account.balance -= amount;

            const debt = {
                id: Date.now().toString(),
                borrowerName: name,
                date,
                time,
                originalAmount: amount,
                remainingAmount: amount,
                methodId,
                methodName: account.name,
                purpose,
                interest,
                status: 'outstanding',
                payments: [],
                createdAt: new Date().toISOString()
            };

            data.debts.push(debt);
            saveData();
            closeModal('debtModal');
            updateAllDisplays();
        }

        function openRepaymentModal(debtId) {
            populateAccountDropdowns();
            document.getElementById('repaymentDebtId').value = debtId;
            openModal('repaymentModal');
        }

        function handleCashHandling() {
            const handling = document.getElementById('cashHandling').value;
            const depositGroup = document.getElementById('depositAccountGroup');
            const partialGroup = document.getElementById('partialAmountGroup');

            depositGroup.classList.add('hidden');
            partialGroup.classList.add('hidden');

            if (handling === 'deposit') {
                depositGroup.classList.remove('hidden');
            } else if (handling === 'partial') {
                depositGroup.classList.remove('hidden');
                partialGroup.classList.remove('hidden');
            }
        }

        function saveRepayment() {
            const debtId = document.getElementById('repaymentDebtId').value;
            const date = document.getElementById('repaymentDate').value;
            const time = document.getElementById('repaymentTime').value;
            const amount = parseFloat(document.getElementById('repaymentAmount').value);
            const methodId = document.getElementById('repaymentMethod').value;
            const handling = document.getElementById('cashHandling').value;
            const notes = document.getElementById('repaymentNotes').value;

            if (!amount || !methodId || !date) {
                alert('Please fill in required fields');
                return;
            }

            const debt = data.debts.find(d => d.id === debtId);
            if (!debt) return;

            const method = data.accounts.find(a => a.id === methodId);

            // Record payment
            debt.payments.push({
                date,
                time,
                amount,
                methodId,
                methodName: method.name,
                handling,
                notes,
                createdAt: new Date().toISOString()
            });

            debt.remainingAmount -= amount;

            if (debt.remainingAmount <= 0) {
                debt.status = 'paid';
                debt.remainingAmount = 0;
            }

            // Handle cash
            if (handling === 'add_cash') {
                const cashAccount = data.accounts.find(a => a.type === 'Cash');
                if (cashAccount) {
                    cashAccount.balance += amount;
                }
            } else if (handling === 'deposit') {
                const depositAccountId = document.getElementById('depositAccount').value;
                const depositAccount = data.accounts.find(a => a.id === depositAccountId);
                if (depositAccount) {
                    depositAccount.balance += amount;
                }
            } else if (handling === 'partial') {
                const depositAmount = parseFloat(document.getElementById('partialDepositAmount').value) || 0;
                const cashAmount = amount - depositAmount;
                
                const depositAccountId = document.getElementById('depositAccount').value;
                const depositAccount = data.accounts.find(a => a.id === depositAccountId);
                if (depositAccount) {
                    depositAccount.balance += depositAmount;
                }
                
                const cashAccount = data.accounts.find(a => a.type === 'Cash');
                if (cashAccount) {
                    cashAccount.balance += cashAmount;
                }
            }

            saveData();
            closeModal('repaymentModal');
            displayDebts();
            updateAllDisplays();
        }

        function displayDebts() {
            const container = document.getElementById('debtList');
            const outstanding = data.debts.filter(d => d.status === 'outstanding');

            if (outstanding.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∏</div><p>No outstanding loans</p></div>';
                return;
            }

            container.innerHTML = outstanding.map(debt => `
                <div class="debt-item">
                    <div class="debt-header">
                        <div class="debt-name">${debt.borrowerName}</div>
                        <div class="debt-amount">‚Ç±${formatNumber(debt.remainingAmount)}</div>
                    </div>
                    <div class="debt-details">
                        Lent: ‚Ç±${formatNumber(debt.originalAmount)} on ${formatDate(debt.date)}<br>
                        Via: ${debt.methodName}
                        ${debt.purpose ? `<br>Purpose: ${debt.purpose}` : ''}
                    </div>
                    ${debt.payments.length > 0 ? `
                        <div class="payment-history">
                            <strong>Payments:</strong>
                            ${debt.payments.map(p => `
                                <div class="payment-item">
                                    <span>${formatDate(p.date)}</span>
                                    <span>‚Ç±${formatNumber(p.amount)}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <button class="btn btn-secondary" style="margin-top:0.75rem" onclick="openRepaymentModal('${debt.id}')">
                        Record Repayment
                    </button>
                </div>
            `).join('');
        }

        // Budgets
        function openBudgetModal() {
            const select = document.getElementById('budgetCategory');
            select.innerHTML = '<option value="">Select Category</option>' + 
                data.categories.expense.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            openModal('budgetModal');
        }

        function saveBudget() {
            const category = document.getElementById('budgetCategory').value;
            const amount = parseFloat(document.getElementById('budgetAmount').value);
            const rollover = document.getElementById('budgetRollover').checked;

            if (!category || !amount) {
                alert('Please fill in all fields');
                return;
            }

            const existing = data.budgets.findIndex(b => b.category === category);
            if (existing >= 0) {
                data.budgets[existing] = { category, amount, rollover };
            } else {
                data.budgets.push({ category, amount, rollover });
            }

            saveData();
            closeModal('budgetModal');
            displayBudgets();
        }

        function displayBudgets() {
            const container = document.getElementById('budgetsList');
            
            if (data.budgets.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∞</div><p>No budgets set</p></div>';
                return;
            }

            const currentMonth = new Date().toISOString().slice(0, 7);
            
            container.innerHTML = data.budgets.map(budget => {
                const spent = data.transactions
                    .filter(t => t.type === 'expense' && 
                                t.category === budget.category && 
                                t.date.startsWith(currentMonth))
                    .reduce((sum, t) => sum + t.amount, 0);

                const percentage = (spent / budget.amount) * 100;
                const remaining = budget.amount - spent;
                
                let progressClass = '';
                if (percentage >= 100) progressClass = 'danger';
                else if (percentage >= 80) progressClass = 'warning';

                return `
                    <div class="card">
                        <h3>${budget.category}</h3>
                        <div style="display: flex; justify-content: space-between; margin: 0.5rem 0;">
                            <span>Spent: ‚Ç±${formatNumber(spent)}</span>
                            <span>Budget: ‚Ç±${formatNumber(budget.amount)}</span>
                        </div>
                        <div class="budget-bar">
                            <div class="budget-progress ${progressClass}" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                        <div style="margin-top: 0.5rem; color: ${remaining >= 0 ? 'var(--success)' : 'var(--danger)'}">
                            ${remaining >= 0 ? 'Remaining' : 'Over budget'}: ‚Ç±${formatNumber(Math.abs(remaining))}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Reports
        function displayReports() {
            displayCategoryReport();
            displayMonthlyComparison();
        }

        function displayCategoryReport() {
            const container = document.getElementById('categoryReport');
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            const categoryTotals = {};
            
            data.transactions
                .filter(t => t.type === 'expense' && t.date.startsWith(currentMonth))
                .forEach(t => {
                    categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
                });

            const sorted = Object.entries(categoryTotals)
                .sort((a, b) => b[1] - a[1]);

            if (sorted.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary)">No expenses this month</p>';
                return;
            }

            const total = sorted.reduce((sum, [, amount]) => sum + amount, 0);

            container.innerHTML = sorted.map(([category, amount]) => {
                const percentage = (amount / total) * 100;
                return `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>${category}</span>
                            <span>‚Ç±${formatNumber(amount)} (${percentage.toFixed(1)}%)</span>
                        </div>
                        <div class="budget-bar">
                            <div class="budget-progress" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayMonthlyComparison() {
            const container = document.getElementById('monthlyComparison');
            
            const last3Months = [];
            const now = new Date();
            
            for (let i = 2; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthStr = date.toISOString().slice(0, 7);
                last3Months.push(monthStr);
            }

            const monthlyData = last3Months.map(month => {
                const income = data.transactions
                    .filter(t => t.type === 'income' && t.date.startsWith(month))
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const expense = data.transactions
                    .filter(t => t.type === 'expense' && t.date.startsWith(month))
                    .reduce((sum, t) => sum + t.amount, 0);

                const [year, monthNum] = month.split('-');
                const monthName = new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'short' });

                return { month: monthName, income, expense, net: income - expense };
            });

            container.innerHTML = monthlyData.map(data => `
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--input-bg); border-radius: 8px;">
                    <h4>${data.month}</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 0.5rem;">
                        <div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary)">Income</div>
                            <div style="color: var(--success)">‚Ç±${formatNumber(data.income)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary)">Expenses</div>
                            <div style="color: var(--danger)">‚Ç±${formatNumber(data.expense)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary)">Net</div>
                            <div style="color: ${data.net >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                ‚Ç±${formatNumber(data.net)}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Dashboard
        function updateDashboard() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            const monthIncome = data.transactions
                .filter(t => t.type === 'income' && t.date.startsWith(currentMonth))
                .reduce((sum, t) => sum + t.amount, 0);
            
            const monthExpense = data.transactions
                .filter(t => t.type === 'expense' && t.date.startsWith(currentMonth))
                .reduce((sum, t) => sum + t.amount, 0);

            const totalDebt = data.debts
                .filter(d => d.status === 'outstanding')
                .reduce((sum, d) => sum + d.remainingAmount, 0);

            document.getElementById('monthIncome').textContent = '‚Ç±' + formatNumber(monthIncome);
            document.getElementById('monthExpense').textContent = '‚Ç±' + formatNumber(monthExpense);
            document.getElementById('totalDebt').textContent = '‚Ç±' + formatNumber(totalDebt);
            document.getElementById('transactionCount').textContent = data.transactions.length;

            // Recent transactions
            const recent = [...data.transactions]
                .sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time))
                .slice(0, 5);

            const recentContainer = document.getElementById('recentTransactions');
            
            if (recent.length === 0) {
                recentContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No transactions yet</p>';
                return;
            }

            recentContainer.innerHTML = recent.map(txn => `
                <div class="transaction-item" style="margin-bottom: 0.5rem;">
                    <div class="transaction-header">
                        <div>
                            <div class="transaction-amount ${txn.type}">
                                ${txn.type === 'expense' ? '-' : '+'}‚Ç±${formatNumber(txn.amount)}
                            </div>
                            <div class="transaction-details">${txn.vendor || txn.category}</div>
                        </div>
                        <div style="text-align: right; font-size: 0.85rem; color: var(--text-secondary)">
                            ${formatDate(txn.date)}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateAllDisplays() {
            updateTotalBalance();
            updateDashboard();
            displayAccounts();
            displayTransactions();
            displayDebts();
            displayBudgets();
            populateAccountDropdowns();
        }

        function updateTotalBalance() {
            const total = data.accounts.reduce((sum, acc) => sum + acc.balance, 0);
            document.getElementById('totalBalance').textContent = '‚Ç±' + formatNumber(total);
        }

        // Categories
        function openCategoryModal() {
            displayCategoriesList();
            openModal('categoryModal');
        }

        function addCategory() {
            const name = document.getElementById('newCategory').value.trim();
            const type = document.getElementById('newCategoryType').value;

            if (!name) {
                alert('Please enter a category name');
                return;
            }

            if (data.categories[type].includes(name)) {
                alert('Category already exists');
                return;
            }

            data.categories[type].push(name);
            saveData();
            displayCategoriesList();
            document.getElementById('newCategory').value = '';
        }

        function displayCategoriesList() {
            const container = document.getElementById('categoriesList');
            
            let html = '<h4>Expense Categories</h4>';
            html += data.categories.expense.map(cat => `
                <div style="padding: 0.5rem; background: var(--input-bg); border-radius: 4px; margin-bottom: 0.25rem;">
                    ${cat}
                </div>
            `).join('');

            html += '<h4 style="margin-top: 1rem;">Income Categories</h4>';
            html += data.categories.income.map(cat => `
                <div style="padding: 0.5rem; background: var(--input-bg); border-radius: 4px; margin-bottom: 0.25rem;">
                    ${cat}
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Data Management
        function exportData() {
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finance-tracker-backup-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (confirm('This will replace all current data. Continue?')) {
                        data = imported;
                        saveData();
                        updateAllDisplays();
                        alert('Data imported successfully');
                    }
                } catch (err) {
                    alert('Error importing file. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('Are you sure? This will delete ALL data permanently.')) {
                if (confirm('Really sure? This cannot be undone!')) {
                    localStorage.removeItem('financeTrackerData');
                    location.reload();
                }
            }
        }

        // Utilities
        function formatNumber(num) {
            return num.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-PH', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function viewTransaction(id) {
            const txn = data.transactions.find(t => t.id === id);
            if (!txn) return;

            let details = `
                Type: ${txn.type}
                Date: ${formatDate(txn.date)} ${txn.time}
                Amount: ‚Ç±${formatNumber(txn.amount)}
                Account: ${txn.accountName}
                Category: ${txn.category}
            `;

            if (txn.subcategory) details += `\nSubcategory: ${txn.subcategory}`;
            if (txn.vendor) details += `\nVendor: ${txn.vendor}`;
            if (txn.brand) details += `\nBrand: ${txn.brand}`;
            if (txn.items) details += `\nItems: ${txn.items}`;
            if (txn.notes) details += `\nNotes: ${txn.notes}`;
            if (txn.installment) {
                details += `\nInstallment: ${txn.installment.current}/${txn.installment.total}`;
                details += `\nRemaining: ‚Ç±${formatNumber(txn.installment.remaining)}`;
            }

            alert(details);
        }

        // Initialize app
        window.addEventListener('load', init);
        window.addEventListener('beforeunload', saveData);
    </script>
</body>
</html>
